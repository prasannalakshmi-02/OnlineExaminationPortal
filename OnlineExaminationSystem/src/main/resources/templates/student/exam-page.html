<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${exam.title} + ' - Online Examination'"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .timer-fixed {
            position: fixed; top: 15px; right: 20px; z-index: 1030; width: 200px;
        }
        .timer-card {
            background: white; border: 3px solid #dc3545; border-radius: 10px;
            padding: 12px 18px; box-shadow: 0 4px 14px rgba(0,0,0,0.2); text-align: center;
        }
        .timer-label { font-size: 0.95rem; color: #555; margin-bottom: 3px; }
        .timer-value { font-size: 2.1rem; font-weight: 700; color: #dc3545; }
        .warning .timer-value { color: #fd7e14; animation: pulse 1.4s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50%      { transform: scale(1.07); }
        }
        .time-up { color: #198754 !important; border-color: #198754 !important; }
        .question-card { margin-bottom: 1.8rem; }
    </style>
</head>
<body class="bg-light">

<div class="timer-fixed">
    <div class="timer-card" id="timerCard">
        <div class="timer-label">Time Remaining</div>
        <div class="timer-value" id="timerDisplay">00:00</div>
    </div>
</div>

<div class="container py-5" style="max-width: 960px;">
    <h2 class="mb-4 text-center" th:text="${exam.title}"></h2>

    <p class="text-muted text-center mb-5"
       th:text="${exam.questions != null ? exam.questions.size() : 0} + ' questions • ' + ${exam.timeLimit} + ' minutes'">
    </p>

    <div class="alert alert-info mb-4">
        <strong>Note:</strong> The exam will <strong>auto-submit</strong> when time expires.<br>
        Do not refresh or close the tab — your progress may be lost.
    </div>

    <form id="examForm" th:action="@{/student/exam/submit}" method="post">
        <input type="hidden" name="examId" th:value="${exam.id}" />

        <div th:each="q, iter : ${questions}" class="card question-card shadow-sm">
            <div class="card-header bg-light fw-bold">
                Question <th:block th:text="${iter.index + 1}"></th:block>
            </div>
            <div class="card-body">
                <p class="mb-3" th:text="${q.content}"></p>

                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" th:name="'question_' + ${q.id}" th:id="'q' + ${q.id} + 'A'" value="A" />
                    <label class="form-check-label" th:for="'q' + ${q.id} + 'A'" th:text="${q.optionA}"></label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" th:name="'question_' + ${q.id}" th:id="'q' + ${q.id} + 'B'" value="B" />
                    <label class="form-check-label" th:for="'q' + ${q.id} + 'B'" th:text="${q.optionB}"></label>
                </div>
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" th:name="'question_' + ${q.id}" th:id="'q' + ${q.id} + 'C'" value="C" />
                    <label class="form-check-label" th:for="'q' + ${q.id} + 'C'" th:text="${q.optionC}"></label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" th:name="'question_' + ${q.id}" th:id="'q' + ${q.id} + 'D'" value="D" />
                    <label class="form-check-label" th:for="'q' + ${q.id} + 'D'" th:text="${q.optionD}"></label>
                </div>
            </div>
        </div>

        <div class="text-center mt-5 mb-5">
            <button type="submit" id="submitBtn" class="btn btn-success btn-lg px-5" disabled>
                Submit Exam
            </button>
        </div>
    </form>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
        const durationMinutes = /*[[${exam.timeLimit}]]*/ 30;
        const totalSeconds = durationMinutes * 60;
        let timeLeft = totalSeconds;

        const timerDisplay = document.getElementById('timerDisplay');
        const timerCard   = document.getElementById('timerCard');
        const submitBtn   = document.getElementById('submitBtn');
        const form        = document.getElementById('examForm');

        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return pad(m) + ":" + pad(s);
        }

        function updateDisplay() {
            timerDisplay.textContent = formatTime(timeLeft);

            if (timeLeft <= 300) {           // last 5 minutes
                timerCard.classList.add('warning');
            }
            if (timeLeft <= 0) {
                timerDisplay.textContent = "Time's Up!";
                timerCard.classList.remove('warning');
                timerCard.classList.add('time-up');
            }
        }

        function startTimer() {
            updateDisplay();
            submitBtn.disabled = false;

            const interval = setInterval(() => {
                timeLeft--;
                updateDisplay();

                if (timeLeft <= 0) {
                    clearInterval(interval);
                    alert("⏰ Time is up! Submitting your exam automatically...");
                    form.submit();
                }
            }, 1000);
        }

        window.addEventListener('beforeunload', (e) => {
            if (timeLeft > 0 && timeLeft < totalSeconds) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        window.addEventListener('load', startTimer);
        document.addEventListener('contextmenu', e => e.preventDefault());
    /*]]>*/
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>